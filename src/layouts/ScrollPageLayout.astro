---
import { getCollection } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE, USER_NAME, GITHUB_USERNAME, SOCIAL_LINKS } from '../consts';
import FormattedDate from '../components/FormattedDate.astro';
import Avatar from '../assets/avatar.png';
import { Image } from 'astro:assets';

interface Props {
	initialSection?: 'home' | 'blog';
}

const { initialSection = 'home' } = Astro.props;

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
);
---

<!doctype html>
<html lang="en" class="scroll-smooth">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style>
			/* Snap Scrolling Setup */
			html, body {
				height: 100%;
				margin: 0;
				padding: 0;
				overflow: hidden; /* Prevent default document scroll */
			}
			
			.scroll-container {
				height: 100dvh;
				overflow-y: scroll;
				scroll-snap-type: y mandatory;
				scroll-behavior: smooth;
			}
			
			.scroll-section {
				height: 100dvh;
				width: 100%;
				scroll-snap-align: start;
				overflow-y: auto; /* Allow internal scrolling if content overflows */
				position: relative;
			}

			/* Home Section Specifics */
			.home-section {
				display: flex;
				flex-direction: column;
			}

			.home-content {
				flex: 1;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				width: 100%;
				padding-top: var(--header-height);
			}

			/* Exact CSS from fabian4.site */
			.home-profile {
				padding: 0 0 .5rem;
				text-align: center;
				display: flex;
				flex-direction: column;
				align-items: center;
			}
			.home-avatar {
				padding: .5rem;
			}
			.avatar {
				display: inline-block;
				width: 8rem;
				height: 8rem;
				margin: 0 auto;
				border-radius: 100%;
				box-shadow: 0 0 0 0.3618em rgba(0,0,0,0.05);
				transition: all 0.4s ease;
				object-fit: cover;
				background-color: #fff;
			}
			.avatar:hover {
				transform: translateY(-0.75rem);
			}
			.home-title {
				font-size: 1.25rem;
				font-weight: bold;
				margin: 0;
				padding: 0.25rem;
				color: var(--black);
			}
			.home-subtitle {
				font-size: 1rem;
				font-weight: normal;
				margin: 0;
				padding: 0.25rem;
				color: var(--black);
			}
			.links {
				padding: 0.5rem;
				font-size: 1.8rem; /* Bigger icons */
				display: flex;
				justify-content: center;
				gap: 0.75rem;
			}
			.links a {
				color: var(--black);
				text-decoration: none;
				transition: color 0.2s;
			}
			.links a:hover {
				color: var(--accent);
			}
			.links a i {
				vertical-align: text-bottom;
			}
			.github-chart {
				width: 100%;
				max-width: 800px;
				height: auto;
				border-radius: 6px;
				margin-top: 0.5rem;
			}

			/* Mobile: Add horizontal margins for GitHub chart */
			@media (max-width: 640px) {
				.github-chart {
					margin-left: 1rem;
					margin-right: 1rem;
					width: calc(100% - 2rem);
				}
			}
			hr {
				width: 100%;
				max-width: 50%;
				margin: 1rem auto;
				border-top: 1px solid var(--border-color);
			}

			/* Blog Section Specifics */
			.blog-section {
				padding-top: var(--header-height);
				display: flex;
				flex-direction: column;
			}

			.blog-list {
				padding: 2rem 0;
				max-width: 72ch;
				margin: 0 auto;
			}

			/* Mobile: Reduce top/bottom padding for faster entry */
			@media (max-width: 640px) {
				.blog-list {
					padding: 1rem 0;
				}
			}

			.post-link {
				display: block;
				text-decoration: none;
				color: inherit;
				margin-bottom: 2rem;
				cursor: pointer;
			}

			/* Mobile: Tighter spacing between posts */
			@media (max-width: 640px) {
				.post-link {
					margin-bottom: 1.25rem;
				}
			}

			.post-item {
				padding-bottom: 1.5rem;
				border-bottom: 1px solid var(--border-color);
				transition: border-color 0.2s;
			}

			/* Mobile: Reduce bottom padding for denser list */
			@media (max-width: 640px) {
				.post-item {
					padding-bottom: 1rem;
				}
			}

			.post-link:last-child .post-item {
				border-bottom: none;
			}

			.post-header {
				display: flex;
				justify-content: space-between;
				align-items: baseline;
				margin-bottom: 0.75rem;
			}

			/* Mobile: Reduce gap between header and summary */
			@media (max-width: 640px) {
				.post-header {
					margin-bottom: 0.5rem;
				}
			}

			.post-title {
				font-size: 1.5rem;
				margin: 0;
				font-weight: 600;
				color: var(--black);
				transition: color 0.2s;
			}

			/* Mobile: Smaller title with tighter line-height for scan efficiency */
			@media (max-width: 640px) {
				.post-title {
					font-size: 1.125rem;
					line-height: 1.4;
				}
			}

			.post-link:hover .post-title {
				color: var(--accent);
			}

			.post-meta {
				font-size: 0.85rem;
				color: var(--gray);
				white-space: nowrap;
			}

			/* Mobile: Smaller date text */
			@media (max-width: 640px) {
				.post-meta {
					font-size: 0.75rem;
				}
			}

			.post-summary {
				color: var(--gray-dark);
				line-height: 1.6;
				font-size: 1rem;
			}

			/* Mobile: Clamp summary to 2 lines, reduce size */
			@media (max-width: 640px) {
				.post-summary {
					font-size: 0.875rem;
					line-height: 1.5;
					display: -webkit-box;
					-webkit-line-clamp: 2;
					-webkit-box-orient: vertical;
					overflow: hidden;
				}
			}

			.no-posts {
				text-align: center;
				padding: 4rem 0;
				color: var(--gray);
				font-size: 1.2rem;
			}

			.post-tags {
				display: flex;
				flex-wrap: wrap;
				gap: 0.5rem;
				margin-top: 1rem;
			}

			/* Mobile: Compress tag spacing */
			@media (max-width: 640px) {
				.post-tags {
					gap: 0.375rem;
					margin-top: 0.625rem;
				}
			}

			.tag {
				background-color: var(--gray-light);
				color: var(--gray);
				padding: 0.1rem 0.4rem;
				border-radius: 4px;
				font-size: 0.75rem;
				font-weight: 500;
				transition: background-color 0.2s, color 0.2s;
			}

			/* Mobile: Smaller tags with reduced padding */
			@media (max-width: 640px) {
				.tag {
					font-size: 0.6875rem;
					padding: 0.0625rem 0.3125rem;
				}
			}

			.post-link:hover .tag {
				background-color: var(--border-color);
				color: var(--accent);
			}
		</style>
	</head>
	<body>
		<div class="scroll-container" id="main-scroll">
			<!-- Home Section -->
			<section id="home" class="scroll-section home-section">
				<Header />
				<div class="home-content">
					<div class="container">
						<div class="home-profile">
							<div class="home-avatar">
								<!-- We use a regular link to /blog if we are on home, but handled via scroll if JS loaded? 
								     Actually, let's keep it simple: Link triggers scroll via onclick, or falls back to /blog -->
								<a href="/blog" onclick="event.preventDefault(); document.getElementById('blog').scrollIntoView({behavior: 'smooth'})" title="Go to Blog">
									<Image src={Avatar} alt="avatar.png" class="avatar" width={256} height={256} />
								</a>
							</div>
							<h1 class="home-title">{USER_NAME}</h1>
							<div class="home-subtitle">{SITE_DESCRIPTION}</div>
							
							<div class="links">
								{SOCIAL_LINKS.map((link) => (
									<a href={link.href} target="_blank" title={link.title} rel="noopener noreffer me">
										<i class={link.icon}></i>
									</a>
								))}
							</div>
							<hr />
							<img 
								src={`https://ghchart.rshah.org/${GITHUB_USERNAME}`} 
								alt={`${USER_NAME}'s Github Chart`} 
								class="github-chart" 
								id="github-chart"
								data-username={GITHUB_USERNAME}
							/>
						</div>
					</div>
				</div>
				<div class="h-16 flex items-center justify-center animate-bounce text-muted cursor-pointer" onclick="document.getElementById('blog').scrollIntoView({behavior: 'smooth'})">
					<i class="fas fa-chevron-down"></i>
				</div>
			</section>

			<!-- Blog Section -->
			<section id="blog" class="scroll-section blog-section">
				<div class="container mx-auto px-4 flex-1">
					<div class="blog-list">
						{
							posts.length === 0 ? (
								<div class="no-posts">
									<p>No posts yet. Check back soon!</p>
								</div>
							) : (
								posts.map((post) => (
									<a href={`/blog/${post.id}/`} class="post-link">
										<article class="post-item">
											<div class="post-header">
												<h2 class="post-title">{post.data.title}</h2>
												<div class="post-meta">
													<FormattedDate date={post.data.date} />
												</div>
											</div>
											<div class="post-summary">
												{post.data.description}
											</div>
											{
												post.data.tags && post.data.tags.length > 0 && (
													<div class="post-tags">
														{post.data.tags.map((tag) => (
															<span class="tag">#{tag}</span>
														))}
													</div>
												)
											}
										</article>
									</a>
								))
							)
						}
					</div>
				</div>
				<Footer />
			</section>
		</div>

		<script is:inline define:vars={{ initialSection }}>
			function updateGithubChart() {
				const chart = document.getElementById('github-chart');
				if (!chart) return;
				
				const username = chart.dataset.username;
				const isDark = document.documentElement.classList.contains('dark');
				if (isDark) {
					chart.src = `https://ghchart.rshah.org/2d89ef/${username}`;
				} else {
					chart.src = `https://ghchart.rshah.org/${username}`;
				}
			}

			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', updateGithubChart);
			} else {
				updateGithubChart();
			}

			window.addEventListener('theme-change', () => {
				updateGithubChart();
			});

			// Initial Scroll Logic
			const scrollContainer = document.getElementById('main-scroll');
			scrollContainer.tabIndex = -1; 
			scrollContainer.focus();

			// Handle initial section
			if (initialSection === 'blog') {
				const blogSection = document.getElementById('blog');
				if (blogSection) {
					// Auto prevents smooth scroll animation on load
					blogSection.scrollIntoView({ behavior: 'auto' });
				}
			} else if (!window.location.hash) {
				scrollContainer.scrollTop = 0;
			}
		</script>
	</body>
</html>
